Abaixo segue um exemplo de **probe (liveness e readiness) em Kubernetes usando `rabbitmqctl` para validar uso de mem√≥ria** e evitar que o pod morra por OOM antes do RabbitMQ entrar em colapso.

---

## ‚úîÔ∏è Ideia da probe

O probe ir√°:

1. Ler a mem√≥ria usada pelo broker via `rabbitmqctl status`.
2. Comparar com um limite seguro (por exemplo, 80% da mem√≥ria do pod).
3. Retornar **0 (sucesso)** se estiver abaixo do limite ‚Üí o pod segue vivo.
4. Retornar **1 (erro)** se ultrapassar o limite ‚Üí for√ßa Kubernetes a reiniciar o pod antes de OOM.

---

## üß™ Script usado pelo probe

Esse script pode ser embutido no livenessProbe ou disponibilizado em um ConfigMap:

```sh
#!/bin/sh

# Mem√≥ria permitida em MB (ajustar ao limite do pod)
MEMORY_LIMIT_MB=6000    # ~6Gi (exemplo)
THRESHOLD_PERCENT=85    # % da utiliza√ß√£o permitida

USED_MB=$(rabbitmqctl status -q | grep -E "total_memory" | awk '{print $2}' | tr -d ',')
# Convers√£o de bytes para MB
USED_MB=$(expr $USED_MB / 1024 / 1024)

# C√°lculo do limiar
LIMIT_MB=$(expr $MEMORY_LIMIT_MB \* $THRESHOLD_PERCENT / 100)

if [ "$USED_MB" -gt "$LIMIT_MB" ]; then
  echo "‚ùå Mem√≥ria alta: ${USED_MB}MB (limite: ${LIMIT_MB}MB)"
  exit 1
else
  echo "‚úì Mem√≥ria dentro do limite: ${USED_MB}MB"
  exit 0
fi
```

---

## üß± Exemplo completo do probe no Deployment/StatefulSet

```yaml
livenessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - |
        MEMORY_LIMIT_MB=6000
        THRESHOLD_PERCENT=85
        USED_MB=$(rabbitmqctl status -q | grep -E "total_memory" | awk '{print $2}' | tr -d ',' | xargs expr / 1024 / 1024)
        LIMIT_MB=$(expr $MEMORY_LIMIT_MB \* $THRESHOLD_PERCENT / 100)
        if [ "$USED_MB" -gt "$LIMIT_MB" ]; then exit 1; else exit 0; fi
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 5
```

### ReadinessProbe similar (para tirar o pod do tr√°fego antes de consumir 100% da RAM)

```yaml
readinessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - |
        MEMORY_LIMIT_MB=6000
        THRESHOLD_PERCENT=80
        USED_MB=$(rabbitmqctl status -q | grep -E "total_memory" | awk '{print $2}' | tr -d ',' | xargs expr / 1024 / 1024)
        LIMIT_MB=$(expr $MEMORY_LIMIT_MB \* $THRESHOLD_PERCENT / 100)
        if [ "$USED_MB" -gt "$LIMIT_MB" ]; then exit 1; else exit 0; fi
  initialDelaySeconds: 15
  periodSeconds: 20
```

---

## üîë Observa√ß√µes importantes

| Ponto                                            | Detalhe                                                        |
| ------------------------------------------------ | -------------------------------------------------------------- |
| O comando `rabbitmqctl` roda dentro do cont√™iner | Portanto o probe deve ser `exec`, n√£o HTTP                     |
| Esse probe atua preventivamente                  | Ele evita OOM, reiniciando o pod quando ultrapassa um limiar   |
| Recomendado junto com alerts de backlog          | Alto uso de mem√≥ria normalmente acompanha ac√∫mulo de mensagens |
| Ajuste do limite                                 | Sempre vincular ao limit de mem√≥ria do pod no recurso K8s      |

---

## üî• Recomenda√ß√µes avan√ßadas

Para evitar restart durante pico normal de carga:

* Use **somente no liveness** (*readiness pode ser mais sens√≠vel*).
* Use `THRESHOLD_PERCENT` mais alto (90‚Äì92%) se o cluster trabalhar com muita fila em mem√≥ria.
* Se o RabbitMQ operar com **Quorum Queues**, considere limiar mais baixo (75‚Äì80%), pois usam muita RAM para replica√ß√£o.

---

Se quiser, posso gerar:
üîπ vers√£o com **ConfigMap + script separado**
üîπ vers√£o adaptada para **RabbitMQ Cluster Operator**
üîπ vers√£o com **valida√ß√£o adicional de memory alarm (`rabbitmqctl eval`)**

Quer alguma dessas? üí™
